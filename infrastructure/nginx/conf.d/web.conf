# ── HTTPS redirect ────────────────────────────────
server {
    listen 80;
    server_name fundiwangu.co.tz www.fundiwangu.co.tz;

    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
    }

    location / {
        return 301 https://$host$request_uri;
    }
}

# ── www redirect ──────────────────────────────────
server {
    listen 443 ssl http2;
    server_name www.fundiwangu.co.tz;

    ssl_certificate     /etc/letsencrypt/live/fundiwangu.co.tz/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/fundiwangu.co.tz/privkey.pem;

    return 301 https://fundiwangu.co.tz$request_uri;
}

# ── Main Website ──────────────────────────────────
server {
    listen 443 ssl http2;
    server_name fundiwangu.co.tz;

    ssl_certificate     /etc/letsencrypt/live/fundiwangu.co.tz/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/fundiwangu.co.tz/privkey.pem;
    ssl_protocols       TLSv1.2 TLSv1.3;
    ssl_prefer_server_ciphers off;

    add_header Strict-Transport-Security "max-age=63072000; includeSubDomains; preload" always;
    add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self' https://fonts.gstatic.com; connect-src 'self' https://api.fundiwangu.co.tz" always;

    # Static assets from Next.js build
    root /var/www/web;

    location /_next/static {
        alias /var/www/web/.next/static;
        expires 365d;
        add_header Cache-Control "public, immutable";
    }

    location / {
        try_files $uri $uri.html $uri/index.html =404;
    }
}

# ── Admin Dashboard ───────────────────────────────
server {
    listen 80;
    server_name admin.fundiwangu.co.tz;

    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
    }

    location / {
        return 301 https://$host$request_uri;
    }
}

server {
    listen 443 ssl http2;
    server_name admin.fundiwangu.co.tz;

    ssl_certificate     /etc/letsencrypt/live/admin.fundiwangu.co.tz/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/admin.fundiwangu.co.tz/privkey.pem;
    ssl_protocols       TLSv1.2 TLSv1.3;

    add_header Strict-Transport-Security "max-age=63072000" always;

    # IP allowlist for admin
    # allow 41.0.0.0/8;    # Tanzania IP ranges
    # deny all;

    root /var/www/admin;

    location /_next/static {
        alias /var/www/admin/.next/static;
        expires 365d;
        add_header Cache-Control "public, immutable";
    }

    location / {
        try_files $uri $uri.html $uri/index.html =404;
    }
}
